@using Simple_CSharp_Games.Models;

<div class="game-container">
    @if (!gameState.IsGameOver)
    {
        @if (showIntro && !showResult && !showManticoreAttack && !showCannon )
        { 
            <div class="intro-section"> 
                <div class="intro-section-content"> 
                    <img class="intro-section-image" src="/images/manticore/intro_image.png" /> 
                    <div class="intro-section-text"> 
                        <p>@IntroText1</p> 
                        <p>@IntroText2</p> 
                        <p>@IntroText3</p>
                        <button class="btn btn-primary mb-2" onclick="@StartGame">Load Cannon</button>
                    </div> 
                </div> 
            </div> 

        } 
        @if (showCannon && !showResult && !showManticoreAttack && !showIntro)
        {
            <div class="load-cannon-section">
                <div class="load-cannon-content">
                    <img class="load-cannon-image" src="/images/manticore/cannon_range.png" />
                    <div class="load-cannon-text">
                        <div class="status-row">
                            <span>City Health: @gameState.City.Health</span>
                            <span>Round: @gameState.Round</span>
                            <span>Manticore Health: @gameState.Manticore.Health</span>
                        </div>

                        <p class="m-2">Set the cannon range for the next shot</p>

                        <input type="number"
                        min="0"
                        max="100"
                        class="form-control mb-2"
                        placeholder="Enter cannon range (0-100)"
                        @bind="guess" />

                        <div class="mb-2">
                            <p>Shots:</p>
                            @foreach (var shot in @gameState.Shots)
                            {
                                <p>@($"Range {shot.Guess} — was {shot.Result}!")</p>
                            }
                        </div>

                        <button class="btn btn-primary mb-2" onclick="@FireCannon">Fire Cannon</button>
                    </div>

                </div>
            </div>


        }
        @if (showResult && !showIntro && !showCannon && !showManticoreAttack)
        {

            @if (gameState.Shots.Last().Result == "Short")
            {
                <div class="short-section">
                    <div class="short-section-content">
                        <img class="short-section-image" src="/images/manticore/shot_short.png" />
                        <div class="short-section-text">
                            <p>That shot fell short.</p>
                            <button class="btn btn-primary mb-2" onclick="@NextStep">Next Step</button>
                        </div>
                    </div>
                </div>
            }

            @if (gameState.Shots.Last().Result == "Long")
            {
                <div class="long-section">
                    <div class="long-section-content">
                        <img class="long-section-image" src="/images/manticore/shot_long.png" />
                        <div class="long-section-text">
                            <p>That shot went long.</p>
                            <button class="btn btn-primary mb-2" onclick="@NextStep">Next Step</button>
                        </div>
                    </div>
                </div>
            }

            @if (gameState.Shots.Last().Result == "Hit")
            {
                <div class="hit-section">
                    <div class="hit-section-content">
                        <img class="hit-section-image" src="/images/manticore/@GetManticoreImage()" />
                        <div class="hit-section-text">
                            <p>Direct hit!</p>
                            <button class="btn btn-primary mb-2" onclick="@NextStep">Next Step</button>
                        </div>
                    </div>
                </div>
            }


        }
        @if (showManticoreAttack && !showIntro && !showCannon && !showResult)
        {
            <div class="manticore-attack-section">
                <div class="manticore-attack-content">
                    <img class="manticore-attack-image" src="/images/manticore/@GetCityImage()" />
                    <div class="manticore-attack-text">
                        <p>The Manticore has hit the city</p>
                        <button class="btn btn-primary mb-2" onclick="@ReloadCannon">Reload Cannon</button>
                    </div>
                </div>
            </div>


        }

    }
    else
    {
        <div class="game-over-section">
            <div class="game-over-content">
                <img class="game-over-image"
                src="/images/manticore/@(gameState.Winner == "City" ? "manticore_dead.png" : "city_destroyed.png")" />
                <div class="game-over-text">
                    <h2>Game Over</h2>
                    <p>
                        @(gameState.Winner == "City"
                                                ? "Victory! The Manticore has been defeated!"
                                                : "Defeat! The Manticore has destroyed the city.")
                    </p>
                    <p class="m-2">The game has ended. Please refresh to play again.</p>

                    <button class="btn btn-primary mb-2" onclick="@Restart">Play Again</button>
                </div>

            </div>
        </div>


    }
</div>

@code {

    private string IntroText1 = "“The Manticore approaches!“ the guard cries.";
    private string IntroText2 = "Man the cannon. Ready the defenses.";
    private string IntroText3 = "This is your city’s final stand.";

    private ManticoreGameState gameState = new ManticoreGameState();

    private int guess;

    private bool showIntro = true;

    private bool showCannon = false;

    private bool showResult = false;

    private bool showManticoreAttack = false;


    private void StartGame()
    {
        showIntro = false;
        showCannon = true;
		showManticoreAttack = false;
		showResult = false;
    }

    private void FireCannon()
    {
        gameState.TakeTurn(guess);
        showResult = true;
		showCannon = false;
		showManticoreAttack = false;
		showIntro = false;

    }

    private void NextStep()
    {
        showManticoreAttack = true;	
        showResult = false;
		showIntro = false;
		showCannon = false;
    }


    private void ReloadCannon()
    {
		showCannon = true;
		showResult = false;
		showIntro = false;
        showManticoreAttack = false;
        guess = 0; 
    }

    private void Restart()
    {
		showIntro = true;
        showResult = false;
        showManticoreAttack = false;
        showCannon = false;
        guess = 0;
        gameState.ResetGame();    
    }

    private string GetCityImage()
    {
        int hp = gameState.City.Health;

        if (hp > 13)
            return "city_battered.png";

        if (hp > 10)
            return "city_scorched.png";

        if (hp > 5)
            return "city_damaged.png";

        if (hp > 0)
            return "city_critical.png";

        return "city_destroyed.png";
    }



    private string GetManticoreImage()
    {
        var hp = gameState.Manticore.Health;

        if (hp == 15)
            return "manticore_healthy.png"; 

        if (hp > 10)
            return "manticore_scratched.png";  

        if (hp > 5)
            return "manticore_burned.png";  

        if (hp > 0)
            return "manticore_bleeding.png";  

        return "manticore_dead.png";  
    }

}