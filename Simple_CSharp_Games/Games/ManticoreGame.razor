@using Simple_CSharp_Games.Models;

<div class="game-container">
    @if (!gameState.IsGameOver)
    {
        @if (!showResult && !showManticoreAttack)
        {
            <div class="load-cannon-section">
                <div class="load-cannon-content">
                    <div class="load-cannon-text">
                        <div class="status-row">
                            <span>City Health: @gameState.City.Health</span>
                            <span>Round: @gameState.Round</span>
                            <span>Manticore Health: @gameState.Manticore.Health</span>
                        </div>

                        <p class="m-2">Set the cannon range for the next shot</p>

                        <input type="number"
                               min="0"
                               max="100"
                               class="form-control mb-2"
                               placeholder="Enter cannon range (0-100)"
                               @bind="guess" />

                        <div class="mb-2">
                            <p>Shots:</p>
                            @foreach (var shot in @gameState.Shots)
                            {
                                <p>@($"Range {shot.Guess} — was {shot.Result}!")</p>
                            }
                        </div>

                        <button class="btn btn-primary mb-2" onclick="@FireCannon">Fire Cannon</button>
                    </div>

                    <img class="load-cannon-image" src="/images/manticore/cannon_range.png" />
                </div>
            </div>


        }
        @if (showResult && !showManticoreAttack )
        {

            @if (gameState.Shots.Last().Result == "Short")
            {
                <div class="short-section">
                    <div class="short-section-content">
                        <div class="short-section-text">
                            <p>That shot fell short.</p>
                            <button class="btn btn-primary mb-2" onclick="@NextStep">Next Step</button>
                        </div>
                        <img class="short-section-image" src="/images/manticore/shot_short.png" />
                    </div>
                </div>
            }

            @if (gameState.Shots.Last().Result == "Long")
            {
                <div class="long-section">
                    <div class="long-section-content">
                        <div class="long-section-text">
                            <p>That shot went long.</p>
                            <button class="btn btn-primary mb-2" onclick="@NextStep">Next Step</button>
                        </div>
                        <img class="long-section-image" src="/images/manticore/shot_long.png" />
                    </div>
                </div>
            }

            @if (gameState.Shots.Last().Result == "Hit")
            {
                <div class="hit-section">
                    <div class="hit-section-content">
                        <div class="hit-section-text">
                            <p>Direct hit!</p>
                            <button class="btn btn-primary mb-2" onclick="@NextStep">Next Step</button>
                        </div>
                        <img class="hit-section-image" src="/images/manticore/@GetManticoreImage()" />
                    </div>
                </div>
            }


        }
        @if (showManticoreAttack && !showResult )
        {
            <div class="manticore-attack-section">
                <div class="manticore-attack-content">
                    <div class="manticore-attack-text">
                        <p>The Manticore has hit the city</p>
                        <button class="btn btn-primary mb-2" onclick="@NextShot">Next Shot</button>
                    </div>
                    <img class="manticore-attack-image" src="/images/manticore/@GetCityImage()" />
                </div>
            </div>


        }

    }
    else
    {
        <div class="game-over-section">
            <div class="game-over-content">
                <div class="game-over-text">
                    <h2>Game Over</h2>
                    <p>
                        @(gameState.Winner == "City"
                            ? "Victory! The Manticore has been defeated!"
                            : "Defeat! The Manticore has destroyed the city.")
                    </p>
                    <p class="m-2">The game has ended. Please refresh to play again.</p>

                    <button class="btn btn-primary mb-2" onclick="@Restart">Play Again</button>
                </div>

                <img class="game-over-image"
                     src="/images/manticore/@(gameState.Winner == "City" ? "manticore_dead.png" : "city_destroyed.png")" />
            </div>
        </div>


    }
</div>

@code {

    private ManticoreGameState gameState = new ManticoreGameState();

    private int guess;

    private bool showResult = false;

    private bool showManticoreAttack = false;

    private void FireCannon()
    {
        gameState.TakeTurn(guess);
        showResult = true;
    }

    private void NextStep()
    {
        showResult = false;
        showManticoreAttack = true;	
    }

    private void NextShot()
    {
        showManticoreAttack = false;
        guess = 0; 
    }

    private void Restart()
    {
        guess = 0;
        showResult = false;
        showManticoreAttack = false;
        gameState.ResetGame();    
    }

    private string GetCityImage()
    {
        int hp = gameState.City.Health;

        if (hp > 13)
            return "city_battered.png";

        if (hp > 10)
            return "city_scorched.png";

        if (hp > 5)
            return "city_damaged.png";

        if (hp > 0)
            return "city_critical.png";

        return "city_destroyed.png";
    }



    private string GetManticoreImage()
    {
        var hp = gameState.Manticore.Health;

        if (hp == 15)
            return "manticore_healthy.png"; 

        if (hp > 10)
            return "manticore_scratched.png";  

        if (hp > 5)
            return "manticore_burned.png";  

        if (hp > 0)
            return "manticore_bleeding.png";  

        return "manticore_dead.png";  
    }

}